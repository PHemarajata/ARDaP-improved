params {
    fastq               =   "*_{1,2}.fastq.gz"
    assemblies          =   false
    assembly_loc        =   "assemblies/*.fasta"
    species             =   "Burkholderia_pseudomallei"
    patientMetaData     =   "${baseDir}/Reports/data/patientMetaData.csv"
    gwas                =   false
	notrim              =   true
    matrix              =   true
    annotate            =   true
    mixtures            =   false
    phylogeny           =   false
    antibiotic_res      =   true
    strain              =   "all"
    tech                =   "Illumina"
    pairing             =   "PE"
    window              =   10000
    indel_merge         =   true
    tri_tetra_allelic   =   false
    size                =   1000000
    phred               =   "-phred33"
    org                 =   "haploid"
    executor            =   "local"
    delly               =   true
	fast                =   true
}

includeConfig 'configs/gatk.config'
conda.enabled = true

// Configure executor for high parallelism on DGX system
executor {
    name = 'local'
    cpus = 128
    memory = '500GB'
    queueSize = 50  // Allow up to 50 concurrent tasks
}

// If the executor is not local, set the conda prefix for processes. Use a
// ternary expression to avoid top-level `if` blocks which conflict with config
// statement ordering.
process.conda = params.executor != 'local' ? System.getenv('CONDA_PREFIX') : null

process {
    executor = params.executor
    errorStrategy = "retry"
	maxRetries = 4
	
	withLabel: art {
        cpus = 1
        memory = { 4.GB * task.attempt }
        time = "8h"
	}
	
    withLabel: card {
        cpus = 1
        memory = "4G"
        time = "8h"
    }

    withLabel: index {
        cpus = 1
        memory = "4G"
        time = "8h"
    }

    withLabel: ardap_default {
        cpus = 2
        memory = { 4.GB * task.attempt }
        time = "24h"
    }

    withLabel: alignment {
        cpus = 4
        memory = { 4.GB * task.attempt }
        time = "24h"
    }
	withLabel: trimmomatic {
        cpus = 2
        memory = { 4.GB * task.attempt }
        time = "24h"
    }
	withLabel: markduplicates {
        cpus = 2
        memory = { 4.GB * task.attempt }
        time = "24h"
    }
    withLabel: gatk_haplo {
        cpus = 4
        memory = { 4.GB * task.attempt }
        time = "24h"
    }
	withLabel: gatk {
        cpus = 4
        memory = { 4.GB * task.attempt }
        time = "24h"
    }

    withLabel: snpeff {
        cpus = 1
        memory = { 4.GB * task.attempt }
        time = "24h"
        // use isolated snpEff conda environment (snpEff v5+)
        conda = "${baseDir}/envs/snpeff.yml"
    }

    withLabel: pindel {
        cpus = 2
        memory = { 4.GB * task.attempt }
        time = "96h"
    }

    withLabel: genomic_queries {
        cpus = 1
        memory = "4G"
        time = "8h"
    }

    withLabel: card_queries {
        cpus = 1
        memory = "4G"
        time = "2h"
    }

    withLabel: report {
        cpus = 1
        memory = "4G"
        time = "2h"
    }

	withLabel: master_vcf {
        cpus = 1
        memory = { 4.GB * task.attempt }
        time = "24h"
    }
	withLabel: snp_matrix {
        cpus = 1
        memory = { 4.GB * task.attempt }
        time = "24h"
    }
}

manifest {
    homePage = 'http://github.com/dsarov/ARDaP'
    description = 'Comprehensive resistance detection from WGS'
    mainScript = 'main.nf'
    version = '1.9'
}

// Custom hardware profiles
// - workstation: 22 cores, 64 GB RAM (optimized for parallelism)
// - dgx: NVIDIA DGX Station A100: ~128 cores, 512 GB RAM (high parallel capacity)
//
// These profiles override per-label CPU/memory defaults declared above. They are
// conservative allocations intended to balance resource usage with parallelism.
// To run use: `nextflow run main.nf -profile workstation` or `-profile dgx`.
profiles {
    workstation {
        // Set max parallel jobs and resource limits for the executor
        executor {
            cpus = 22
            memory = '64 GB'
            // Allow up to 8 jobs to run simultaneously (adjust based on your workflow)
            queueSize = 8
        }
        
        process {
            // Optimized for 22 cores, 64GB RAM - balanced for parallelism
            // Principle: No single process should use >50% of resources
            
            // Lightweight processes - keep small for maximum parallelism
            withLabel: art { cpus = 1; memory = '4G' }
            withLabel: card { cpus = 1; memory = '4G' }
            withLabel: index { cpus = 1; memory = '4G' }
            withLabel: ardap_default { cpus = 2; memory = '6G' }
            withLabel: trimmomatic { cpus = 2; memory = '6G' }
            withLabel: genomic_queries { cpus = 1; memory = '4G' }
            withLabel: card_queries { cpus = 1; memory = '4G' }
            withLabel: report { cpus = 1; memory = '4G' }
            withLabel: snpeff { cpus = 1; memory = '4G'; conda = "${baseDir}/envs/snpeff.yml" }
            withLabel: master_vcf { cpus = 2; memory = '8G' }
            withLabel: snp_matrix { cpus = 2; memory = '8G' }
            
            // Medium processes - balanced resource allocation
            withLabel: markduplicates { cpus = 3; memory = '12G' }
            
            // Heavy processes - reduced from original to allow parallelism
            // These can now run 3-4 in parallel instead of 2-3
            withLabel: alignment { cpus = 6; memory = '20G' }
            withLabel: gatk_haplo { cpus = 6; memory = '20G' }
            withLabel: gatk { cpus = 6; memory = '20G' }
            
            // Pindel was the biggest bottleneck - reduced significantly
            // From 4 cores/48GB to 4 cores/24GB allows better parallelism
            withLabel: pindel { cpus = 4; memory = '24G' }
        }
    }

    dgx {
        process {
            // hardware totals: 128 cores, 512G RAM — generous allocations for heavy steps
            withLabel: art { cpus = 2;  memory = '8G' }
            withLabel: card { cpus = 2; memory = '8G' }
            withLabel: index { cpus = 4; memory = '16G' }
            withLabel: ardap_default { cpus = 8; memory = '32G' }
            // alignment, GATK and haplotype steps are CPU and memory heavy — scale up
            withLabel: alignment { cpus = 32; memory = '128G' }
            withLabel: trimmomatic { cpus = 8; memory = '32G' }
            withLabel: markduplicates { cpus = 8; memory = '64G' }
            withLabel: gatk_haplo { cpus = 32; memory = '128G' }
            withLabel: gatk { cpus = 32; memory = '128G' }
            withLabel: snpeff { cpus = 4; memory = '16G'; conda = "${baseDir}/envs/snpeff.yml" }
            withLabel: pindel { cpus = 16; memory = '256G' }
            withLabel: genomic_queries { cpus = 4; memory = '16G' }
            withLabel: card_queries { cpus = 4; memory = '16G' }
            withLabel: report { cpus = 2; memory = '8G' }
            withLabel: master_vcf { cpus = 8; memory = '64G' }
            withLabel: snp_matrix { cpus = 8; memory = '64G' }
        }
    }
}